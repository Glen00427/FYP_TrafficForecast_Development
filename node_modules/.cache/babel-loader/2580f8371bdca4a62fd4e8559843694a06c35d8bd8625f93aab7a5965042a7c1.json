{"ast":null,"code":"import React,{useEffect,useMemo,useRef,useState}from\"react\";import{supabase}from\"../lib/supabaseClient\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function AuthGate(_ref){let{appName=\"SG Traffic Forecast\",onAuthed,onGuest,onSignUp}=_ref;const[email,setEmail]=useState(\"\");const[password,setPassword]=useState(\"\");const[submitted,setSubmitted]=useState(false);const[loading,setLoading]=useState(false);const[authErr,setAuthErr]=useState(\"\");const emailRef=useRef(null);// lock body scroll while gate is shown\nuseEffect(()=>{const prev=document.body.style.overflow;document.body.style.overflow=\"hidden\";setTimeout(()=>{var _emailRef$current;return(_emailRef$current=emailRef.current)===null||_emailRef$current===void 0?void 0:_emailRef$current.focus();},0);return()=>document.body.style.overflow=prev;},[]);const errs=useMemo(()=>{const e={};if(!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email))e.email=\"Valid email required\";if(!password)e.password=\"Password required\";return e;},[email,password]);async function handleSignIn(ev){ev.preventDefault();setSubmitted(true);setAuthErr(\"\");if(Object.keys(errs).length)return;const emailNorm=(email||\"\").trim().toLowerCase();const pass=(password||\"\").trim();try{var _data$password,_ref2,_ref3,_data$id,_data$name,_data$email,_data$phone;setLoading(true);// Select * to avoid schema mismatch (id vs userid vs user_id)\nconst{data,error}=await supabase.from(\"users\").select(\"*\").ilike(\"email\",emailNorm).limit(1).maybeSingle();if(error){console.error(\"AuthGate SELECT error:\",error);setAuthErr(\"Something went wrong. Please try again.\");return;}if(!data){setAuthErr(\"Incorrect email or password.\");return;}if(String((_data$password=data.password)!==null&&_data$password!==void 0?_data$password:\"\").trim()!==pass){setAuthErr(\"Incorrect email or password.\");return;}const uid=(_ref2=(_ref3=(_data$id=data.id)!==null&&_data$id!==void 0?_data$id:data.userid)!==null&&_ref3!==void 0?_ref3:data.user_id)!==null&&_ref2!==void 0?_ref2:\"local\";onAuthed===null||onAuthed===void 0?void 0:onAuthed({id:uid,name:(_data$name=data.name)!==null&&_data$name!==void 0?_data$name:\"\",email:(_data$email=data.email)!==null&&_data$email!==void 0?_data$email:emailNorm,phone:(_data$phone=data.phone)!==null&&_data$phone!==void 0?_data$phone:\"\",role:\"user\"});}catch(e){console.error(\"AuthGate exception:\",e);setAuthErr(\"Something went wrong. Please try again.\");}finally{setLoading(false);}}return/*#__PURE__*/_jsx(\"div\",{className:\"gate-backdrop\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"gate-card\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"gate-close\",\"aria-label\":\"Close\",disabled:true,children:\"\\u2715\"}),/*#__PURE__*/_jsx(\"div\",{className:\"gate-logo\",\"aria-hidden\":true,children:\"\\uD83D\\uDE97\"}),/*#__PURE__*/_jsxs(\"h1\",{className:\"gate-title\",children:[\"Welcome to \",appName]}),/*#__PURE__*/_jsx(\"p\",{className:\"gate-sub\",children:\"Sign in to continue\"}),/*#__PURE__*/_jsxs(\"form\",{className:\"gate-form\",onSubmit:handleSignIn,children:[/*#__PURE__*/_jsx(\"label\",{className:\"usf-label\",htmlFor:\"gate-email\",children:\"Email\"}),/*#__PURE__*/_jsx(\"input\",{id:\"gate-email\",ref:emailRef,className:\"usf-input\",type:\"email\",placeholder:\"Enter email...\",value:email,onChange:e=>setEmail(e.target.value),autoComplete:\"email\"}),submitted&&errs.email&&/*#__PURE__*/_jsx(\"div\",{className:\"usf-error\",children:errs.email}),/*#__PURE__*/_jsx(\"label\",{className:\"usf-label\",htmlFor:\"gate-password\",children:\"Password\"}),/*#__PURE__*/_jsx(\"input\",{id:\"gate-password\",className:\"usf-input\",type:\"password\",placeholder:\"Enter password...\",value:password,onChange:e=>setPassword(e.target.value),autoComplete:\"current-password\"}),submitted&&errs.password&&/*#__PURE__*/_jsx(\"div\",{className:\"usf-error\",children:errs.password}),authErr&&/*#__PURE__*/_jsx(\"div\",{className:\"usf-error\",children:authErr}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"usf-btn usf-btn-primary\",disabled:loading,children:loading?\"Signing in...\":\"Sign In\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"gate-signup\",children:[\"Need an account?\",\" \",/*#__PURE__*/_jsx(\"button\",{className:\"gate-link\",onClick:onSignUp,children:\"Sign up\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"gate-divider\",children:/*#__PURE__*/_jsx(\"span\",{children:\"OR\"})}),/*#__PURE__*/_jsxs(\"button\",{className:\"gate-guest-btn\",onClick:onGuest,children:[/*#__PURE__*/_jsx(\"span\",{className:\"gate-guest-ico\",\"aria-hidden\":true,children:\"\\uD83D\\uDC64\"}),\"Continue as Guest User\"]})]})});}","map":{"version":3,"names":["React","useEffect","useMemo","useRef","useState","supabase","jsx","_jsx","jsxs","_jsxs","AuthGate","_ref","appName","onAuthed","onGuest","onSignUp","email","setEmail","password","setPassword","submitted","setSubmitted","loading","setLoading","authErr","setAuthErr","emailRef","prev","document","body","style","overflow","setTimeout","_emailRef$current","current","focus","errs","e","test","handleSignIn","ev","preventDefault","Object","keys","length","emailNorm","trim","toLowerCase","pass","_data$password","_ref2","_ref3","_data$id","_data$name","_data$email","_data$phone","data","error","from","select","ilike","limit","maybeSingle","console","String","uid","id","userid","user_id","name","phone","role","className","children","disabled","onSubmit","htmlFor","ref","type","placeholder","value","onChange","target","autoComplete","onClick"],"sources":["/workspaces/FYP_TrafficForecast/src/components/AuthGate.js"],"sourcesContent":["import React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport { supabase } from \"../lib/supabaseClient\";\n\nexport default function AuthGate({\n  appName = \"SG Traffic Forecast\",\n  onAuthed,\n  onGuest,\n  onSignUp,\n}) {\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [submitted, setSubmitted] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [authErr, setAuthErr] = useState(\"\");\n  const emailRef = useRef(null);\n\n  // lock body scroll while gate is shown\n  useEffect(() => {\n    const prev = document.body.style.overflow;\n    document.body.style.overflow = \"hidden\";\n    setTimeout(() => emailRef.current?.focus(), 0);\n    return () => (document.body.style.overflow = prev);\n  }, []);\n\n  const errs = useMemo(() => {\n    const e = {};\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email))\n      e.email = \"Valid email required\";\n    if (!password) e.password = \"Password required\";\n    return e;\n  }, [email, password]);\n\n  async function handleSignIn(ev) {\n    ev.preventDefault();\n    setSubmitted(true);\n    setAuthErr(\"\");\n    if (Object.keys(errs).length) return;\n\n    const emailNorm = (email || \"\").trim().toLowerCase();\n    const pass = (password || \"\").trim();\n\n    try {\n      setLoading(true);\n\n      // Select * to avoid schema mismatch (id vs userid vs user_id)\n      const { data, error } = await supabase\n        .from(\"users\")\n        .select(\"*\")\n        .ilike(\"email\", emailNorm)\n        .limit(1)\n        .maybeSingle();\n\n      if (error) {\n        console.error(\"AuthGate SELECT error:\", error);\n        setAuthErr(\"Something went wrong. Please try again.\");\n        return;\n      }\n      if (!data) {\n        setAuthErr(\"Incorrect email or password.\");\n        return;\n      }\n\n      if (String(data.password ?? \"\").trim() !== pass) {\n        setAuthErr(\"Incorrect email or password.\");\n        return;\n      }\n\n      const uid = data.id ?? data.userid ?? data.user_id ?? \"local\";\n\n      onAuthed?.({\n        id: uid,\n        name: data.name ?? \"\",\n        email: data.email ?? emailNorm,\n        phone: data.phone ?? \"\",\n        role: \"user\",\n      });\n    } catch (e) {\n      console.error(\"AuthGate exception:\", e);\n      setAuthErr(\"Something went wrong. Please try again.\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"gate-backdrop\">\n      <div className=\"gate-card\">\n        <button className=\"gate-close\" aria-label=\"Close\" disabled>\n          âœ•\n        </button>\n\n        <div className=\"gate-logo\" aria-hidden>\n          ðŸš—\n        </div>\n        <h1 className=\"gate-title\">Welcome to {appName}</h1>\n        <p className=\"gate-sub\">Sign in to continue</p>\n\n        <form className=\"gate-form\" onSubmit={handleSignIn}>\n          <label className=\"usf-label\" htmlFor=\"gate-email\">\n            Email\n          </label>\n          <input\n            id=\"gate-email\"\n            ref={emailRef}\n            className=\"usf-input\"\n            type=\"email\"\n            placeholder=\"Enter email...\"\n            value={email}\n            onChange={(e) => setEmail(e.target.value)}\n            autoComplete=\"email\"\n          />\n          {submitted && errs.email && (\n            <div className=\"usf-error\">{errs.email}</div>\n          )}\n\n          <label className=\"usf-label\" htmlFor=\"gate-password\">\n            Password\n          </label>\n          <input\n            id=\"gate-password\"\n            className=\"usf-input\"\n            type=\"password\"\n            placeholder=\"Enter password...\"\n            value={password}\n            onChange={(e) => setPassword(e.target.value)}\n            autoComplete=\"current-password\"\n          />\n          {submitted && errs.password && (\n            <div className=\"usf-error\">{errs.password}</div>\n          )}\n\n          {authErr && <div className=\"usf-error\">{authErr}</div>}\n\n          <button\n            type=\"submit\"\n            className=\"usf-btn usf-btn-primary\"\n            disabled={loading}\n          >\n            {loading ? \"Signing in...\" : \"Sign In\"}\n          </button>\n        </form>\n\n        <div className=\"gate-signup\">\n          Need an account?{\" \"}\n          <button className=\"gate-link\" onClick={onSignUp}>\n            Sign up\n          </button>\n        </div>\n\n        <div className=\"gate-divider\">\n          <span>OR</span>\n        </div>\n\n        <button className=\"gate-guest-btn\" onClick={onGuest}>\n          <span className=\"gate-guest-ico\" aria-hidden>\n            ðŸ‘¤\n          </span>\n          Continue as Guest User\n        </button>\n      </div>\n    </div>\n  );\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}